name: Build

on:
  push:
    branches: ['*']
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  VERSION: "1.2.1"

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Test
        run: dotnet test --verbosity normal

      - name: Build
        if: github.event_name == 'pull_request'
        run: dotnet build src/Slipstream/Slipstream.csproj -c Release

      - name: Publish Standalone
        if: github.event_name == 'push'
        run: dotnet publish src/Slipstream/Slipstream.csproj -c Release -r win-x64 --self-contained false -p:PublishSingleFile=true -p:Version=${{ env.VERSION }} -o publish/standalone

      - name: Publish Installer Build
        if: github.event_name == 'push'
        run: dotnet publish src/Slipstream/Slipstream.csproj -c Release -r win-x64 --self-contained false -p:PublishSingleFile=true -p:Version=${{ env.VERSION }} -o publish/installer-build

      - name: Install NSIS
        if: github.event_name == 'push'
        run: choco install nsis -y

      - name: Create Installer
        if: github.event_name == 'push'
        run: |
          $installerScript = @"
          !include "MUI2.nsh"

          !define PRODUCT_NAME "Slipstream"
          !define PUBLISHER "Tsonu"
          !define COMPANY "Ahara"
          !define WEBSITE "https://github.com/chris-arsenault/slipstream"

          !define MUI_ICON "installer-build\Resources\app.ico"
          !define MUI_UNICON "installer-build\Resources\app.ico"

          Name "`${PRODUCT_NAME}"
          OutFile "Slipstream-${{ env.VERSION }}-Setup.exe"
          InstallDir "`$LOCALAPPDATA\Slipstream"
          RequestExecutionLevel user

          VIProductVersion "${{ env.VERSION }}.0"
          VIAddVersionKey "ProductName" "`${PRODUCT_NAME}"
          VIAddVersionKey "CompanyName" "`${COMPANY}"
          VIAddVersionKey "Publisher" "`${PUBLISHER}"
          VIAddVersionKey "FileDescription" "Slipstream Clipboard Manager"
          VIAddVersionKey "FileVersion" "${{ env.VERSION }}"
          VIAddVersionKey "LegalCopyright" "Â© 2025 `${PUBLISHER}"
          VIAddVersionKey "ProductVersion" "${{ env.VERSION }}"

          !insertmacro MUI_PAGE_DIRECTORY
          !insertmacro MUI_PAGE_INSTFILES
          !insertmacro MUI_LANGUAGE "English"

          !define UNINSTALL_REG_KEY "Software\Microsoft\Windows\CurrentVersion\Uninstall\`${PRODUCT_NAME}"

          ; Check for .NET 8 Desktop Runtime
          Function CheckDotNet8
            ; Check for .NET 8.x Desktop Runtime in registry
            ReadRegStr `$0 HKLM "SOFTWARE\dotnet\Setup\InstalledVersions\x64\sharedfx\Microsoft.WindowsDesktop.App" "8.0.0"
            StrCmp `$0 "" checkOtherVersions dotnetFound

            checkOtherVersions:
            ; Check for any 8.x version
            EnumRegKey `$1 HKLM "SOFTWARE\dotnet\Setup\InstalledVersions\x64\sharedfx\Microsoft.WindowsDesktop.App" 0
            StrCmp `$1 "" noDotNet
            StrCpy `$2 `$1 2 ; Get first 2 chars
            StrCmp `$2 "8." dotnetFound
            Goto noDotNet

            noDotNet:
            MessageBox MB_YESNO|MB_ICONEXCLAMATION "Slipstream requires .NET 8 Desktop Runtime which was not detected.$\n$\nWould you like to open the download page?$\n$\nClick Yes to open the download page, or No to continue anyway." IDNO dotnetFound
            ExecShell "open" "https://dotnet.microsoft.com/en-us/download/dotnet/8.0"
            Abort

            dotnetFound:
          FunctionEnd

          ; Check if app is running and prompt to close
          Function .onInit
            Call CheckDotNet8

            FindWindow `$0 "" "Slipstream"
            StrCmp `$0 0 notRunning
              MessageBox MB_OKCANCEL|MB_ICONEXCLAMATION "Slipstream is currently running.$\n$\nClick OK to close it and continue, or Cancel to abort." IDOK closeApp
              Abort
            closeApp:
              FindWindow `$0 "" "Slipstream"
              StrCmp `$0 0 notRunning
              SendMessage `$0 16 0 0 ; WM_CLOSE
              Sleep 1000
              Goto closeApp
            notRunning:
          FunctionEnd

          Function un.onInit
            FindWindow `$0 "" "Slipstream"
            StrCmp `$0 0 notRunning
              MessageBox MB_OKCANCEL|MB_ICONEXCLAMATION "Slipstream is currently running.$\n$\nClick OK to close it and continue, or Cancel to abort." IDOK closeApp
              Abort
            closeApp:
              FindWindow `$0 "" "Slipstream"
              StrCmp `$0 0 notRunning
              SendMessage `$0 16 0 0 ; WM_CLOSE
              Sleep 1000
              Goto closeApp
            notRunning:
          FunctionEnd

          Section "Install"
            SetOutPath "`$INSTDIR"
            File /r "installer-build\*.*"
            CreateShortcut "`$DESKTOP\Slipstream.lnk" "`$INSTDIR\Slipstream.exe"
            CreateShortcut "`$SMPROGRAMS\Slipstream.lnk" "`$INSTDIR\Slipstream.exe"
            WriteUninstaller "`$INSTDIR\Uninstall.exe"

            ; Add to Add/Remove Programs
            WriteRegStr HKCU "`${UNINSTALL_REG_KEY}" "DisplayName" "`${PRODUCT_NAME}"
            WriteRegStr HKCU "`${UNINSTALL_REG_KEY}" "DisplayVersion" "${{ env.VERSION }}"
            WriteRegStr HKCU "`${UNINSTALL_REG_KEY}" "Publisher" "`${PUBLISHER}"
            WriteRegStr HKCU "`${UNINSTALL_REG_KEY}" "DisplayIcon" "`$INSTDIR\Slipstream.exe"
            WriteRegStr HKCU "`${UNINSTALL_REG_KEY}" "UninstallString" "`$INSTDIR\Uninstall.exe"
            WriteRegStr HKCU "`${UNINSTALL_REG_KEY}" "InstallLocation" "`$INSTDIR"
            WriteRegStr HKCU "`${UNINSTALL_REG_KEY}" "URLInfoAbout" "`${WEBSITE}"
            WriteRegDWORD HKCU "`${UNINSTALL_REG_KEY}" "NoModify" 1
            WriteRegDWORD HKCU "`${UNINSTALL_REG_KEY}" "NoRepair" 1
          SectionEnd

          Section "Uninstall"
            ; Remove from Add/Remove Programs
            DeleteRegKey HKCU "`${UNINSTALL_REG_KEY}"

            RMDir /r "`$INSTDIR"
            Delete "`$DESKTOP\Slipstream.lnk"
            Delete "`$SMPROGRAMS\Slipstream.lnk"
          SectionEnd
          "@
          $installerScript | Out-File -FilePath publish/installer.nsi -Encoding UTF8
        shell: pwsh

      - name: Build NSIS Installer
        if: github.event_name == 'push'
        uses: joncloud/makensis-action@v4
        with:
          script-file: publish/installer.nsi
          arguments: "/V3"

      - name: Prepare Release Assets
        if: github.event_name == 'push'
        run: |
          mv publish/standalone/Slipstream.exe publish/Slipstream-${{ env.VERSION }}-Portable.exe
          mv publish/Slipstream-${{ env.VERSION }}-Setup.exe publish/
        shell: bash

      - name: Upload Portable
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: Slipstream-Portable
          path: publish/Slipstream-${{ env.VERSION }}-Portable.exe

      - name: Upload Installer
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: Slipstream-Installer
          path: publish/Slipstream-${{ env.VERSION }}-Setup.exe

      - name: Create Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          name: Slipstream v${{ env.VERSION }}
          body: |
            ## Downloads
            - **Slipstream-${{ env.VERSION }}-Portable.exe** - Standalone executable, no installation required
            - **Slipstream-${{ env.VERSION }}-Setup.exe** - Windows installer with Start Menu and Desktop shortcuts
          files: |
            publish/Slipstream-${{ env.VERSION }}-Portable.exe
            publish/Slipstream-${{ env.VERSION }}-Setup.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
